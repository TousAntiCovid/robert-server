image: registry.gitlab.inria.fr/stemcovid19/tac-server/docker-image/tac-oraclejava8:latest

variables:
  MAVEN_CLI_OPTS: "-Dmaven.repo.local=.m2/repository --batch-mode"
  GIT_SUBMODULE_STRATEGY: recursive
  
cache:
  paths:
    - .m2/repository/

stages:
  - build
  - test
  - docker
  - deploy

build_robert-server:
  stage: build
  script:
    # build all (for other phase such as docker) but skip tests
    - mvn $MAVEN_CLI_OPTS -DskipTests=true -P swagger,logstash  package
  artifacts:
    paths:
      - robert-server/robert-server-ws-rest/target/*.jar
      - robert-server/robert-crypto-grpc-server/target/*.jar
      - tac-warning/tac-warning-ws-rest/target/*.jar
      - tac-warning/tac-warning-ws-rest/target/*.jar
  rules:
    - when: always

build_system_test:
  stage: build
  script:
    # build all (for other phase such as integration test) but skip tests
    - cd system-test
    - mvn $MAVEN_CLI_OPTS -DskipTests=true package
  artifacts:
    paths:
      - system_test/target/*.jar
  rules:
    - when: always
    
build_robert-push-notif-server:
  stage: build
  script:
    - cd robert-push-notif-server
    # build all (for other phase such as docker) but skip tests
    - mvn $MAVEN_CLI_OPTS -DskipTests=true package
  artifacts:
    paths:
      - robert-push-notif-server/robert-push-notif-server-ws-rest/target/*.jar
  rules:
    - when: always
    
build_submission-code-server:
  stage: build
  script:
    - cd submission-code-server
    # build all (for other phase such as docker) but skip tests
    - mvn $MAVEN_CLI_OPTS -DskipTests=true package
  artifacts:
    paths:
      - submission-code-server/submission-code-server-ws-rest/target/*.jar
  rules:
    - when: always


test_with_report:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS -P report org.jacoco:jacoco-maven-plugin:prepare-agent org.jacoco:jacoco-maven-plugin:prepare-agent-integration verify  jacoco:report-integration jacoco:report site
  artifacts:
    when: always
    paths:
      - target/site/**
      - robert-server/target/site/**
      - tac-warning/target/site/**
      - robert-server/*/target/site/**
      - tac-warning/*/target/site/**
    reports:
      junit:
        - "robert-server/*/target/surefire-reports/TEST-*.xml"
        - "robert-server/*/target/failsafe-reports/TEST-*.xml" 
        - "tac-warning/*/target/surefire-reports/TEST-*.xml"
        - "tac-warning/*/target/failsafe-reports/TEST-*.xml" 
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
    - if: '$CI_COMMIT_BRANCH =~ /.*_reporting/'
      when: always
    - when: never
        
test:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS verify
  artifacts:
    when: always
    reports:
      junit:
        - "robert-server/*/target/surefire-reports/TEST-*.xml"
        - "robert-server/*/target/failsafe-reports/TEST-*.xml" 
        - "tac-warning/*/target/surefire-reports/TEST-*.xml"
        - "tac-warning/*/target/failsafe-reports/TEST-*.xml" 
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /.*skip_ut.*/'
      when: never
    - if: '$CI_COMMIT_BRANCH =~ /.*_reporting/'
      when: never
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: never
    - when: on_success
 
docker-robert-crypto-grpc-server:
  image: registry.gitlab.inria.fr/stemcovid19/tac-server/docker-image/docker-git:latest
  tags:    
    - qlf-ci.inria.fr # required to to ensure https://gitlab.inria.fr/inria-ci/qlf-ci-gitlab-runner#building-and-pushing-docker-images
  stage: docker
  dependencies:
    - build_robert-server
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH'
      when: manual
    - if: $CI_MERGE_REQUEST_ID
      when: manual
  script:
    - source .gitlab-ci/compute_extra_env.sh
    - cd robert-server/robert-crypto-grpc-server
    - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.inria.fr/stemcovid19/wp3-robert-server/hsm-tools 
    - docker login -u $DOCKER_IO_USER -p $DOCKER_IO_TOKEN
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/stemcovid19/tac-server/backend-server/robert-crypto-grpc-server:$DOCKER_TAG -f src/main/docker/Dockerfile .
    - | 
      if [[ ! $DOCKER_TAG = "ci-transient" ]] 
      then         
         docker push $CI_REGISTRY/stemcovid19/tac-server/backend-server/robert-crypto-grpc-server:$DOCKER_TAG
      else
         echo not in a branch, do not push to registry
      fi
    
docker-robert-server-ws-rest:
  image: registry.gitlab.inria.fr/stemcovid19/tac-server/docker-image/docker-git:latest
  tags:    
    - qlf-ci.inria.fr # required to to ensure https://gitlab.inria.fr/inria-ci/qlf-ci-gitlab-runner#building-and-pushing-docker-images
  stage: docker
  dependencies:
    - build_robert-server
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH'
      when: manual 
    - if: $CI_MERGE_REQUEST_ID
      when: manual
  script:
    - source .gitlab-ci/compute_extra_env.sh
    - cd robert-server/robert-server-ws-rest
    - docker login -u $DOCKER_IO_USER -p $DOCKER_IO_TOKEN
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/stemcovid19/tac-server/backend-server/robert-server-ws-rest:$DOCKER_TAG -f src/main/docker/Dockerfile .
    - echo $CI_COMMIT_BRANCH
    - | 
      if [[ ! $DOCKER_TAG = "ci-transient" ]] 
      then
         docker push $CI_REGISTRY/stemcovid19/tac-server/backend-server/robert-server-ws-rest:$DOCKER_TAG
      else
         echo not in a branch, do not push to registry
      fi  
      
docker-tac-warning:
  image: registry.gitlab.inria.fr/stemcovid19/tac-server/docker-image/docker-git:latest
  tags:    
    - qlf-ci.inria.fr # required to to ensure https://gitlab.inria.fr/inria-ci/qlf-ci-gitlab-runner#building-and-pushing-docker-images
  stage: docker
  dependencies:
    - build_robert-server
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH'
      when: manual 
    - if: $CI_MERGE_REQUEST_ID
      when: manual
  script:
    - source .gitlab-ci/compute_extra_env.sh
    - cd tac-warning/tac-warning-ws-rest
    - docker login -u $DOCKER_IO_USER -p $DOCKER_IO_TOKEN
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/stemcovid19/tac-server/backend-server/tac-warning-ws-rest:$DOCKER_TAG -f src/main/docker/Dockerfile .
    - | 
      if [[ ! $DOCKER_TAG = "ci-transient" ]] 
      then 
         docker push $CI_REGISTRY/stemcovid19/tac-server/backend-server/tac-warning-ws-rest:$DOCKER_TAG
      else
         echo not in a branch, do not push to registry
      fi
      
docker-robert-push-notif-server:
  image: registry.gitlab.inria.fr/stemcovid19/tac-server/docker-image/docker-git:latest
  tags:    
    - qlf-ci.inria.fr # required to to ensure https://gitlab.inria.fr/inria-ci/qlf-ci-gitlab-runner#building-and-pushing-docker-images
  stage: docker
  dependencies:
    - build_robert-push-notif-server 
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH'
      when: manual 
    - if: $CI_MERGE_REQUEST_ID
      when: manual
  script:
    - source .gitlab-ci/compute_extra_env.sh
    - cd robert-push-notif-server/robert-push-notif-server-ws-rest
    - docker login -u $DOCKER_IO_USER -p $DOCKER_IO_TOKEN
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/stemcovid19/tac-server/backend-server/robert-push-notif-server-ws-rest:$DOCKER_TAG -f src/main/docker/Dockerfile .
    - | 
      if [[ ! $DOCKER_TAG = "ci-transient" ]] 
      then 
         docker push $CI_REGISTRY/stemcovid19/tac-server/backend-server/robert-push-notif-server-ws-rest:$DOCKER_TAG
      else
         echo not in a branch, do not push to registry
      fi 
      
docker-submission-code-server:
  image: registry.gitlab.inria.fr/stemcovid19/tac-server/docker-image/docker-git:latest
  tags:    
    - qlf-ci.inria.fr # required to to ensure https://gitlab.inria.fr/inria-ci/qlf-ci-gitlab-runner#building-and-pushing-docker-images
  stage: docker
  dependencies:
    - build_submission-code-server
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH'
      when: manual 
    - if: $CI_MERGE_REQUEST_ID
      when: manual
  script:
    - source .gitlab-ci/compute_extra_env.sh
    - cd submission-code-server/submission-code-server-ws-rest
    - docker login -u $DOCKER_IO_USER -p $DOCKER_IO_TOKEN
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/stemcovid19/tac-server/backend-server/submission-code-server-ws-rest:$DOCKER_TAG -f src/main/docker/Dockerfile .
    - | 
      if [[ ! $DOCKER_TAG = "ci-transient" ]] 
      then 
         docker push $CI_REGISTRY/stemcovid19/tac-server/backend-server/submission-code-server-ws-rest:$DOCKER_TAG
      else
         echo not in a branch, do not push to registry
      fi 
      
      
docker-captcha-orange-server:
  image: registry.gitlab.inria.fr/stemcovid19/tac-server/docker-image/docker-git:latest
  tags:    
    - qlf-ci.inria.fr # required to to ensure https://gitlab.inria.fr/inria-ci/qlf-ci-gitlab-runner#building-and-pushing-docker-images
  stage: docker
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH'
      when: manual 
    - if: $CI_MERGE_REQUEST_ID
      when: manual
  script:
    - source .gitlab-ci/compute_extra_env.sh
    - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.inria.fr/stemcovid19/wp3-robert-server/cicd/deploy_captcha-orange.git
    - cd deploy_captcha-orange
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/stemcovid19/tac-server/backend-server/deploy-captcha-orange-rest:$DOCKER_TAG -f docker/Dockerfile .
    - | 
      if [[ ! $DOCKER_TAG = "ci-transient" ]] 
      then 
         docker push $CI_REGISTRY/stemcovid19/tac-server/backend-server/deploy-captcha-orange-rest:$DOCKER_TAG
      else
          echo not in a branch, do not push to registry
      fi 
      
pages:
  image: busybox
  stage: deploy
  artifacts:
    paths:
      - public
  script:
    - mkdir public
    - cp -r target/site/* public
    - source .gitlab-ci/copy_site.sh
  rules :
    - if: '$CI_COMMIT_BRANCH =~ /.*_reporting/'
      when: always
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
    - when: never
  
      